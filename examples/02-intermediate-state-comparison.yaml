# Example: Intermediate State Comparison Test
# Purpose: Advanced state management - inventory changes, state comparisons,
#          and JSONPath extraction for multi-player interactions
#
# This test demonstrates:
# - Pre/post state capture for both players
# - Multi-player test coordination
# - JSONPath data extraction from RCON responses
# - Inventory state comparison between players
# - Complex cleanup with entity removal
#
# Tags: intermediate, multi-player, state, inventory, jsonpath

name: "Intermediate State Comparison Test"
description: "Demonstrates advanced Pilaf features: state capture before/after actions, JSONPath extraction, multi-player interactions, and inventory state comparison"

setup:
  # Wait to avoid connection throttling from previous test
  - action: "wait"
    duration: 10000
    name: "Wait to avoid throttling"

  # Connect two players (use unique names to avoid throttling)
  - action: "connect_player"
    player: "player_alpha_123"
    name: "Connect player alpha"

  # Wait between connections to avoid throttling
  - action: "wait"
    duration: 5000
    name: "Wait between connections"

  - action: "connect_player"
    player: "player_beta_456"
    name: "Connect player beta"

  # Give player alpha some items to demonstrate state changes
  - action: "execute_rcon_command"
    command: "give player_alpha_123 diamond 64"
    name: "Give player alpha diamonds"

  - action: "execute_rcon_command"
    command: "give player_alpha_123 emerald 32"
    name: "Give player alpha emeralds"

  # Give player beta different items
  - action: "execute_rcon_command"
    command: "give player_beta_456 iron_ingot 10"
    name: "Give player beta iron"

  # Capture initial states (before changes)
  - action: "execute_rcon_with_capture"
    command: "data get entity @p[name=player_alpha_123,limit=1] Inventory"
    store_as: "alpha_before"
    name: "Store alpha inventory before"

  - action: "execute_rcon_with_capture"
    command: "data get entity @p[name=player_beta_456,limit=1] Inventory"
    store_as: "beta_before"
    name: "Store beta inventory before"

  # Set spawn points for both players
  - action: "execute_rcon_command"
    command: "execute as player_alpha_123 at @s run spawnpoint @s ~ ~ ~"
    name: "Set alpha spawn"

  - action: "execute_rcon_command"
    command: "execute as player_beta_456 at @s run spawnpoint @s ~ ~ ~"
    name: "Set beta spawn"

steps:
  # Player alpha gives some items to player beta using /give
  - action: "execute_player_command"
    player: "player_alpha_123"
    command: "give player_beta_456 diamond 10"
    name: "Alpha gives diamonds to beta"

  - action: "wait"
    duration: 2000
    name: "Wait for command processing"

  # Player beta gives items to alpha
  - action: "execute_player_command"
    player: "player_beta_456"
    command: "give player_alpha_123 iron_ingot 5"
    name: "Beta gives iron to alpha"

  - action: "wait"
    duration: 2000
    name: "Wait for command processing"

  # Capture post-transaction states (after changes)
  - action: "execute_rcon_with_capture"
    command: "data get entity @p[name=player_alpha_123,limit=1] Inventory"
    store_as: "alpha_after"
    name: "Store alpha inventory after"

  - action: "execute_rcon_with_capture"
    command: "data get entity @p[name=player_beta_456,limit=1] Inventory"
    store_as: "beta_after"
    name: "Store beta inventory after"

  # Compare inventory states
  - action: "compare_states"
    state1: "alpha_before"
    state2: "alpha_after"
    store_as: "alpha_diff"
    name: "Compare alpha inventory"

  - action: "compare_states"
    state1: "beta_before"
    state2: "beta_after"
    store_as: "beta_diff"
    name: "Compare beta inventory"

  # Print comparison results
  - action: "print_state_comparison"
    variable_name: "alpha_diff"
    name: "Show alpha inventory changes"

  - action: "print_state_comparison"
    variable_name: "beta_diff"
    name: "Show beta inventory changes"

  # Example: Extract player health using JSONPath
  - action: "execute_rcon_with_capture"
    command: "data get entity @p[name=player_alpha_123,limit=1] Health"
    store_as: "alpha_data_raw"
    name: "Get alpha health data"

  - action: "extract_with_jsonpath"
    source_variable: "alpha_data_raw"
    json_path: "$.Health"
    store_as: "alpha_health"
    name: "Extract health value"

  # Verify the extracted health value
  - action: "store_state"
    value: 20
    store_as: "expected_health"
    name: "Store expected health"

  - action: "assert_condition"
    condition: "${alpha_health} == ${expected_health}"
    name: "Verify player health"

cleanup:
  # Clear any test items
  - action: "execute_rcon_command"
    command: "clear player_alpha_123"
    name: "Clear alpha inventory"

  - action: "execute_rcon_command"
    command: "clear player_beta_456"
    name: "Clear beta inventory"

  # Wait to avoid connection throttling
  - action: "wait"
    duration: 5000
    name: "Wait before disconnecting"

  # Disconnect players
  - action: "disconnect_player"
    player: "player_alpha_123"
    name: "Disconnect alpha"

  - action: "disconnect_player"
    player: "player_beta_456"
    name: "Disconnect beta"
