# Comprehensive Plugin Test Example
# Demonstrates Pilaf's complete feature set for testing complex plugin behaviors
#
# This test suite covers:
# - Entity operations via RCON
# - Block/world operations and inventory management
# - State management and comparisons
#
# Tags: advanced, entity, block, health, state

name: "Comprehensive Plugin Test Suite"
description: "Full demonstration of Pilaf capabilities testing a hypothetical RPG plugin"

setup:
  # Wait to avoid connection throttling from previous test
  - action: "wait"
    duration: 10000
    name: "Wait to avoid throttling"

  # Connect single admin player for testing
  - action: "connect_player"
    player: "admin_test_alpha"
    name: "Connect admin player"

  # Pre-load inventory
  - action: "execute_rcon_command"
    command: "give admin_test_alpha diamond_sword 1"
    name: "Give admin diamond sword"

  - action: "execute_rcon_command"
    command: "give admin_test_alpha golden_apple 3"
    name: "Give admin golden apples"

  # Spawn test entities via RCON
  - action: "execute_rcon_command"
    command: "summon zombie 5 64 5 {CustomName:test_zombie}"
    name: "Spawn test zombie"

  - action: "execute_rcon_command"
    command: "summon skeleton 10 64 10 {CustomName:test_skeleton}"
    name: "Spawn test skeleton"

  # Store entity health before using data command
  - action: "execute_rcon_with_capture"
    command: "data get entity @e[name=test_zombie,limit=1] Health"
    store_as: "zombie_health_initial"
    name: "Store zombie health before"

steps:
  # Section 1: Entity Operations - Spawning and Verification

  # Verify zombie exists by attempting to get its data (will fail if doesn't exist)
  - action: "execute_rcon_with_capture"
    command: "data get entity @e[name=test_zombie,limit=1]"
    store_as: "zombie_check"
    name: "Verify zombie exists"

  # Verify skeleton exists
  - action: "execute_rcon_with_capture"
    command: "data get entity @e[name=test_skeleton,limit=1]"
    store_as: "skeleton_check"
    name: "Verify skeleton exists"

  # Section 2: Entity Health and Damage Operations

  # Deal damage to entity via RCON
  - action: "execute_rcon_command"
    command: "damage @e[name=test_zombie,limit=1] 5"
    name: "Deal 5 damage to zombie"

  # Get health after damage
  - action: "execute_rcon_with_capture"
    command: "data get entity @e[name=test_zombie,limit=1] Health"
    store_as: "zombie_health_after"
    name: "Get zombie health after damage"

  # Store full health (20 for zombies)
  - action: "store_state"
    value: 20
    store_as: "zombie_health_full"
    name: "Store expected full health"

  # Compare health states
  - action: "compare_states"
    state1: "zombie_health_full"
    state2: "zombie_health_after"
    store_as: "damage_result"
    name: "Compare health change"

  # Kill the entity
  - action: "execute_rcon_command"
    command: "kill @e[name=test_skeleton,limit=1]"
    name: "Kill test skeleton"

  # Verify skeleton no longer exists (command will fail if entity doesn't exist)
  - action: "execute_rcon_command"
    command: "execute if entity @e[name=test_skeleton,limit=1] run say SKELETON_EXISTS"
    name: "Verify skeleton removed"

  # Section 3: Server Chat Message

  # Send chat message via server (say is a server command, not player command)
  - action: "execute_rcon_command"
    command: "say [TEST] Admin test message"
    name: "Send server chat message"

  - action: "wait"
    duration: 1000
    name: "Wait for chat propagation"

  # Section 4: Block/World Operations

  # Place test block
  - action: "execute_rcon_command"
    command: "setblock 100 64 100 stone"
    name: "Place test stone block"

  # Verify block type via RCON
  - action: "execute_rcon_with_capture"
    command: "data get block 100 64 100"
    store_as: "block_data"
    name: "Get block data"

  # Section 5: Inventory Management

  # Check player inventory (list items in hotbar)
  - action: "execute_rcon_with_capture"
    command: "data get entity @p[name=admin_test_alpha,limit=1] Inventory"
    store_as: "inventory_check"
    name: "Check player inventory"

  # Section 6: State Management

  # Print state comparison
  - action: "print_state_comparison"
    variable_name: "damage_result"
    name: "Show damage comparison"

cleanup:
  # Clear test entities
  - action: "execute_rcon_command"
    command: "kill @e[name=test_zombie,limit=1]"
    name: "Kill test zombie"

  # Remove test block
  - action: "execute_rcon_command"
    command: "setblock 100 64 100 air"
    name: "Remove test block"

  # Clear inventory
  - action: "execute_rcon_command"
    command: "clear admin_test_alpha"
    name: "Clear admin inventory"

  # Wait before disconnecting
  - action: "wait"
    duration: 5000
    name: "Wait before disconnecting"

  # Disconnect player
  - action: "disconnect_player"
    player: "admin_test_alpha"
    name: "Disconnect admin"
