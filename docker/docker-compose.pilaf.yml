# PILAF Complete Docker Stack
# This docker-compose file sets up the complete PILAF testing environment:
# - PaperMC Minecraft Server (1.21.8)
# - Mineflayer Bridge for player automation
# - RCON server for command execution
#
# Plugin handling:
# - Base image plugins are in /plugins (not affected by /data volume)
# - Use PLUGIN_URL to download additional plugins on startup
# - Custom plugins can be placed in ./plugins directory
services:
  # PaperMC Minecraft Server
  papermc:
    image: itzg/minecraft-server:java21
    container_name: pilaf-papermc
    ports:
      - "35115:25565"  # Minecraft server port (external:35115 -> internal:25565)
      - "35125:25575"  # RCON port (external:35125 -> internal:25575)
    volumes:
      # World data and configs - these persist across restarts
      - papermc-data:/data
      # Mount custom plugins directory - these will be loaded alongside base plugins
      - ./plugins:/plugins/custom:ro
    environment:
      # Accept EULA
      - EULA=true

      # Version and Type - Updated to 1.21.8
      - TYPE=PAPER
      - VERSION=1.21.8

      # RCON Configuration
      - ENABLE_RCON=true
      - RCON_PASSWORD=dragon123
      - RCON_PORT=25575

      # Server Configuration
      - SERVER_NAME=PILAF-Test-Server
      - MAX_PLAYERS=10
      - ONLINE_MODE=false
      - GAMEMODE=survival
      - DIFFICULTY=peaceful

      # Performance Settings for Testing
      - VIEW_DISTANCE=10
      - SIMULATION_DISTANCE=10

      # Plugin URLs - Download additional plugins on startup
      # Add your plugin URLs here (one per line, no quotes)
      # - https://github.com/placeholder/plugins/releases/download/v1.0/plugin.jar

    # Health check to ensure server is ready
    healthcheck:
      test: ["CMD-SHELL", "rcon-cli list > /dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

    # Network configuration
    networks:
      - pilaf-network

  # Mineflayer Bridge Service
  mineflayer-bridge:
    build:
      context: ../mineflayer-bridge
      dockerfile: Dockerfile
    container_name: pilaf-mineflayer-bridge
    ports:
      - "8888:3000"  # Mineflayer API port (external:8888 -> internal:3000)
    environment:
      # Minecraft Connection
      - MC_HOST=papermc
      - MC_PORT=25565

      # RCON Connection
      - MC_RCON_HOST=papermc
      - MC_RCON_PORT=25575
      - MC_RCON_PASSWORD=dragon123

      # Bridge Configuration
      - BRIDGE_LOG_LEVEL=INFO
      - BRIDGE_PLAYER_NAME=pilaf_tester
      - BRIDGE_AUTO_RECONNECT=true
      - BRIDGE_CONNECTION_TIMEOUT=30000

      # API Configuration
      - API_HOST=0.0.0.0
      - API_PORT=3000
      - API_RATE_LIMIT=100

    # Network configuration - must be same network as papermc
    networks:
      - pilaf-network

    # NOTE: Mineflayer bridge will wait for PaperMC via retry logic in its code
    # Do not use depends_on with health checks as they can fail
    # depends_on:
    #   papermc:
    #     condition: service_started

# Network configuration
networks:
  pilaf-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# Volume configuration
volumes:
  papermc-data:
    driver: local
    name: pilaf-papermc-data
