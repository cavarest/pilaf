<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pilaf Test Report - __SUITENAME__</title>
  <link href="https://fonts.cdnfonts.com/css/minecraft-pe" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>__CSSCONTENT__</style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <div id="app">
    <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50 p-4">
      <h1 class="text-xl font-bold">Pilaf Test Report</h1>
      <p class="text-sm text-gray-400">{{ report.suiteName }}</p>
      <span class="px-3 py-1 rounded-full text-sm font-semibold"
            :class="report.passed ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'">
        {{ report.passed ? 'PASSED' : 'FAILED' }}
      </span>
    </header>
    <main class="max-w-7xl mx-auto px-4 py-6">
      <div v-for="story in stories" :key="story.name" class="bg-gray-800 rounded-lg p-4 mb-4 border border-gray-700">
        <h2 class="text-lg font-semibold text-white">{{ story.name }}</h2>
        <p class="text-sm text-gray-400">{{ story.passedCount }} passed, {{ story.failedCount }} failed</p>

        <!-- Console Logs for this Story -->
        <div v-if="story.consoleLogs && story.consoleLogs.length > 0" class="mt-3 border border-gray-700 rounded">
          <button @click="toggleStoryConsole(story.name)"
                  class="w-full px-3 py-2 flex items-center justify-between text-left hover:bg-gray-700 rounded transition-colors">
            <span class="text-sm font-medium text-gray-300">Console Logs</span>
            <span class="text-gray-400">{{ isStoryConsoleExpanded(story.name) ? '‚ñº' : '‚ñ∂' }}</span>
          </button>
          <div v-show="isStoryConsoleExpanded(story.name)" class="p-3 border-t border-gray-700 max-h-60 overflow-y-auto">
            <div class="font-mono text-xs space-y-1">
              <div v-for="(log, index) in story.consoleLogs" :key="index"
                   class="text-gray-300 hover:text-white transition-colors">
                <span class="text-gray-500 select-none">[{{ formatTime(log.timestamp) }}]</span> {{ log.message }}
              </div>
            </div>
          </div>
        </div>

        <!-- Steps -->
        <div class="mt-3">
          <h3 class="text-sm font-medium text-gray-300 mb-2">Steps</h3>
          <div v-for="(step, stepIndex) in story.steps" :key="step.name" class="ml-4 mt-2">
            <div @click="toggleStep(story.name, stepIndex)"
                 class="p-2 rounded cursor-pointer hover:bg-gray-700/50 transition-colors flex items-center justify-between"
                 :class="step.passed ? 'bg-green-900/30' : 'bg-red-900/30'">
              <div class="flex items-center gap-2">
                <span class="text-gray-400">{{ isStepExpanded(story.name, stepIndex) ? '‚ñº' : '‚ñ∂' }}</span>
                <span class="font-mono text-sm">{{ step.name }}</span>
              </div>
              <span v-if="step.executionContext" class="px-2 py-0.5 rounded text-xs bg-gray-700">
                {{ step.executionContext.executor }}
              </span>
            </div>
            <div v-show="isStepExpanded(story.name, stepIndex)" class="ml-4 mt-2 p-3 bg-gray-900/50 rounded border border-gray-700">
              <div v-if="step.details && step.details.length > 0" class="space-y-2">
                <template v-for="(detail, idx) in step.details" :key="idx">
                  <!-- Action/Response pair display -->
                  <div v-if="detail.type === 'action'" class="font-mono text-xs text-yellow-300">
                    ‚Üí {{ detail.message }}
                  </div>
                  <div v-else-if="detail.type === 'response'" class="font-mono text-xs text-green-300 ml-4">
                    ‚Üê {{ detail.message }}
                  </div>
                  <!-- Other details -->
                  <div v-else
                       class="font-mono text-xs"
                       :class="getDetailClass(detail.message)">
                    {{ formatDetail(detail.message) }}
                  </div>
                </template>
              </div>
              <div v-else class="text-gray-500 text-sm italic">No details available</div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  <script>
    const reportData = __STORIESJSON__;
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          report: reportData,
          stories: reportData.stories || [],
          expandedSteps: new Set(),
          expandedStoryConsoles: new Set()
        };
      },
      methods: {
        formatTime(timestamp) {
          const date = new Date(timestamp);
          return date.toTimeString().split(' ')[0];
        },
        toggleStep(storyName, stepIndex) {
          const key = `${storyName}-${stepIndex}`;
          if (this.expandedSteps.has(key)) {
            this.expandedSteps.delete(key);
          } else {
            this.expandedSteps.add(key);
          }
          this.expandedSteps = new Set(this.expandedSteps);
        },
        isStepExpanded(storyName, stepIndex) {
          return this.expandedSteps.has(`${storyName}-${stepIndex}`);
        },
        toggleStoryConsole(storyName) {
          if (this.expandedStoryConsoles.has(storyName)) {
            this.expandedStoryConsoles.delete(storyName);
          } else {
            this.expandedStoryConsoles.add(storyName);
          }
          this.expandedStoryConsoles = new Set(this.expandedStoryConsoles);
        },
        isStoryConsoleExpanded(storyName) {
          return this.expandedStoryConsoles.has(storyName);
        },
        formatDetail(message) {
          // Format common patterns for better readability
          return message
            .replace(/^RCON command: /, '‚Üí ')
            .replace(/^Found /, '‚Ä¢ Found ')
            .replace(/^Retrieved /, '‚Ä¢ Retrieved ')
            .replace(/^Stored result as /, 'üíæ Saved: ')
            .replace(/^Waited /, '‚è± Waited ')
            .replace(/^Assertion passed: /, '‚úì ')
            .replace(/^Assertion failed: /, '‚úó ')
            .replace(/^ location: /, ' üìç ')
            .replace(/^ chat: /, ' üí¨ ')
            .replace(/^ executed command: /, ' ‚ö° ');
        },
        getDetailClass(message) {
          if (message.includes('Assertion passed:')) return 'text-green-400';
          if (message.includes('Assertion failed:')) return 'text-red-400';
          if (message.includes('RCON command:')) return 'text-yellow-300';
          if (message.includes('Found ') || message.includes('Retrieved ')) return 'text-blue-300';
          if (message.includes('Stored result as')) return 'text-purple-300';
          if (message.includes('Waited ')) return 'text-gray-400';
          return 'text-gray-300';
        }
      }
    }).mount('#app');
  </script>
</body>
</html>

