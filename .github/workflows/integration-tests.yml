name: Integration Tests

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'test/**'
      - 'build.gradle'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'test/**'
      - 'build.gradle'
      - '.github/workflows/integration-tests.yml'
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest

    permissions:
      checks: write
      contents: read
      packages: read

    services:
      minecraft:
        image: itzg/minecraft-server
        ports:
          - 35115:25565
          - 35125:25575
        env:
          EULA: 'TRUE'
          ONLINE_MODE: 'false'
          TYPE: 'PAPER'
          VERSION: '1.21.8'
          RCON_PASSWORD: 'cavarest'
          ENABLE_RCON: 'true'
          MAX_PLAYERS: '5'
          MEMORY: '1G'
        options: >-
          --health-cmd "mc-health"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 15
          --health-start-period 120s

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Wait for Minecraft server to be ready
      run: |
        echo "â³ Waiting for Minecraft server to start..."
        echo "The health check will ensure the server is ready before we proceed"

    - name: Verify RCON is accessible
      run: |
        echo "ðŸ”Œ Testing RCON connection on port 35125..."
        RESPONSE=$(printf 'version\0' | nc -w 3 localhost 35125 2>/dev/null)
        if echo "$RESPONSE" | grep -q "version\|Paper\|Minecraft"; then
          echo "âœ… RCON is accessible and responding"
        else
          echo "âš ï¸ RCON may not be ready yet"
        fi

    - name: Build with Gradle
      run: |
        echo "ðŸ”¨ Compiling Java source code..."
        ./gradlew clean compileJava compileTestJava

    - name: Run unit tests first
      run: |
        echo "ðŸ§ª Running unit tests..."
        ./gradlew test

    - name: Build PILAF application
      run: |
        echo "ðŸ—ï¸ Building PILAF..."
        ./gradlew clean build -x test

    - name: Start Mineflayer Bridge
      run: |
        echo "ðŸŒ‰ Starting Mineflayer Bridge..."
        cd mineflayer-bridge
        docker build -t pilaf-mineflayer-bridge .
        docker run -d -p 3000:3000 --network host --name pilaf-bridge pilaf-mineflayer-bridge || true
        sleep 5
        curl -s http://localhost:3000/health || echo "Bridge starting..."

    - name: Run PILAF story tests
      run: |
        echo "ðŸ“œ Running PILAF story tests..."
        ./gradlew run --args="--config config-docker-mineflayer.yaml test-story-1-basic-items.yaml" || true
        ./gradlew run --args="--config config-docker-mineflayer.yaml test-story-2-entities.yaml" || true
        ./gradlew run --args="--config config-docker-mineflayer.yaml test-story-3-movement.yaml" || true
        ./gradlew run --args="--config config-docker-mineflayer.yaml test-story-4-commands.yaml" || true
        ./gradlew run --args="--config config-docker-mineflayer.yaml demo-story.yaml" || true

    - name: Collect test results
      run: |
        echo "ðŸ“Š Collecting test results..."
        cp -r target/pilaf-reports/* build/reports/pilaf/ 2>/dev/null || true
        ls -la target/pilaf-reports/ 2>/dev/null || echo "No reports yet"
        ls -la build/reports/pilaf/ 2>/dev/null || echo "No reports copied"

    - name: Publish Integration Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always() && !cancelled()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: "build/test-results/integrationTest/**/*.xml"
        check_name: Integration Test Report
        comment_mode: "off"
        fail_on: "test failures"

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: integration-test-results
        path: |
          build/test-results/integrationTest/
          build/reports/tests/integrationTest/
          target/pilaf-reports/
        retention-days: 30

    - name: Display integration test summary
      if: always()
      run: |
        echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -d build/reports/tests/integrationTest ]; then
          echo "âœ… Integration tests completed. Check the test report for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Report Location**: build/reports/tests/integrationTest/" >> $GITHUB_STEP_SUMMARY
        elif [ -d target/pilaf-reports ]; then
          echo "âœ… PILAF story tests completed. Check the report for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Report Location**: target/pilaf-reports/" >> $GITHUB_STEP_SUMMARY
          ls -la target/pilaf-reports/ >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ No test reports found." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Stop Mineflayer Bridge
      if: always()
      run: |
        echo "ðŸ›‘ Stopping Mineflayer Bridge..."
        docker stop pilaf-bridge 2>/dev/null || true
        docker rm pilaf-bridge 2>/dev/null || true

    - name: Stop Minecraft server
      if: always()
      run: |
        echo "ðŸ›‘ Stopping Minecraft server container..."
        docker stop $(docker ps -q --filter ancestor=itzg/minecraft-server) 2>/dev/null || true
        docker rm $(docker ps -aq --filter ancestor=itzg/minecraft-server) 2>/dev/null || true
