name: Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
    workflow_dispatch:

permissions:
  checks: write
  contents: read
  packages: read
  pull-requests: write

jobs:
  integration-test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    services:
      minecraft:
        image: itzg/minecraft-server
        ports:
          - 25565:25565
          - 25575:25575
        env:
          EULA: 'TRUE'
          ONLINE_MODE: 'false'
          TYPE: 'PAPER'
          VERSION: '1.21.8'
          RCON_PASSWORD: 'cavarest'
          ENABLE_RCON: 'true'
          RCON_PORT: '25575'
          MAX_PLAYERS: '5'
          MEMORY: '1G'
          SPAWN_PROTECTION: '0'
          DEBUG: 'false'
          # Reduce connection throttling for testing
          # Allow faster reconnections by increasing the login timeout
          CONNECTION_TIMEOUT_THRESHOLD: '120000'

          # === DETERMINISTIC FLAT WORLD FOR TESTING ===
          LEVEL: 'pilaf-test'
          LEVEL_TYPE: 'FLAT'
          SEED: '1234567890'
          GENERATE_STRUCTURES: 'false'
          MAX_WORLD_SIZE: '50'
          MODE: 'creative'
          DIFFICULTY: 'peaceful'
          PVP: 'false'
          ALLOW_NETHER: 'false'

          # === PERFORMANCE FOR TESTING ===
          VIEW_DISTANCE: '4'
          SIMULATION_DISTANCE: '4'

          # === ENTITY SPAWNING FOR TESTING ===
          SPAWN_ANIMALS: 'true'     # Enable for entity testing
          SPAWN_MONSTERS: 'true'    # Enable for entity combat testing
          SPAWN_NPCS: 'false'

          # === CUSTOM FLAT WORLD LAYERS ===
          GENERATOR_SETTINGS: '{"layers":[{"block":"minecraft:bedrock","height":1},{"block":"minecraft:dirt","height":2},{"block":"minecraft:grass_block","height":1}],"biome":"minecraft:plains"}'
        options: >-
          --name pilaf-minecraft
          --health-cmd "mc-health"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 15
          --health-start-period 120s

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10

    - name: Get pnpm store directory
      id: pnpm-cache
      shell: bash
      run: |
        echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

    - name: Setup pnpm cache
      uses: actions/cache@v4
      with:
        path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
        key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pnpm-store-

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: pnpm install --frozen-lockfile

    - name: Verify RCON is accessible
      run: |
        echo "ðŸ”Œ Testing RCON connection..."
        for i in {1..30}; do
          RESPONSE=$(echo -ne "version\\0version\\0" | nc -w 2 localhost 25575 2>/dev/null | xxd | head -1)
          if [ -n "$RESPONSE" ]; then
            echo "âœ… RCON is accessible and responding"
            break
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

    - name: Wait for Minecraft server to fully initialize
      run: |
        echo "â³ Waiting for Minecraft server to fully initialize..."
        sleep 90
        echo "âœ… Server should be ready"

    - name: Run tests
      env:
        RCON_HOST: localhost
        RCON_PORT: 25575
        RCON_PASSWORD: cavarest
        MC_HOST: localhost
        MC_PORT: 25565
        CI: true
      run: |
        echo "ðŸ§ª Running Pilaf integration tests..."
        pnpm test:ci

    - name: Publish test results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always() && !cancelled()
      with:
        files: "test-results/**/*.xml"
        check_name: Integration Test Report
        comment_mode: "off"
        fail_on: "test failures"

    - name: Upload Pilaf HTML reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pilaf-html-reports
        path: target/pilaf-reports/
        retention-days: 30
        if-no-files-found: ignore

    - name: Display test summary
      if: always()
      run: |
        echo "## Integration Test Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… Integration tests completed." >> $GITHUB_STEP_SUMMARY
        if [ -d target/pilaf-reports ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pilaf HTML Reports" >> $GITHUB_STEP_SUMMARY
          echo "HTML reports have been uploaded as artifacts." >> $GITHUB_STEP_SUMMARY
        fi

    - name: Stop Minecraft server
      if: always()
      run: |
        echo "ðŸ›‘ Stopping Minecraft server container..."
        docker stop $(docker ps -q --filter ancestor=itzg/minecraft-server) 2>/dev/null || true
        docker rm $(docker ps -aq --filter ancestor=itzg/minecraft-server) 2>/dev/null || true
