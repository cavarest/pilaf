name: Integration Tests

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

jobs:
  integration-test:
    runs-on: ubuntu-latest

    permissions:
      checks: write
      contents: read
      packages: read

    services:
      minecraft:
        image: itzg/minecraft-server
        ports:
          - 25565:25565
          - 25575:25575
        env:
          EULA: 'TRUE'
          ONLINE_MODE: 'false'
          TYPE: 'PAPER'
          VERSION: '1.21.8'
          RCON_PASSWORD: 'dragon123'
          ENABLE_RCON: 'true'
          RCON_PORT: '25575'
          MAX_PLAYERS: '5'
          MEMORY: '1G'
          SPAWN_PROTECTION: '0'
          DEBUG: 'false'
        options: >-
          --name pilaf-minecraft
          --health-cmd "mc-health"
          --health-interval 30s
          --health-timeout 10s
          --health-retries 15
          --health-start-period 120s

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Set up JDK 21
      uses: actions/setup-java@v5
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Wait for Minecraft server to be ready
      run: |
        echo "â³ Waiting for Minecraft server to start..."
        echo "The health check will ensure the server is ready before we proceed"

    - name: Verify RCON is accessible
      run: |
        echo "ðŸ”Œ Testing RCON connection..."
        RESPONSE=$(printf 'version\\0' | nc -w 3 localhost 25575 2>/dev/null)
        if echo "$RESPONSE" | grep -q "version\\|Paper\\|Minecraft"; then
          echo "âœ… RCON is accessible and responding"
        else
          echo "âš ï¸ RCON may not be ready yet"
        fi

    - name: Build Mineflayer Bridge image
      uses: docker/build-push-action@v6
      with:
        context: mineflayer-bridge
        tags: pilaf-mineflayer-bridge
        load: true
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build with Gradle
      run: |
        echo "ðŸ”¨ Compiling Java source code..."
        ./gradlew clean compileJava compileTestJava

    - name: Create CI config file
      run: |
        echo "ðŸ“ Creating CI configuration..."
        cat > config-ci.yaml << EOF
        # Configuration for GitHub Actions CI
        server_backend: rcon
        client_backend: none

        # Server settings
        rcon_host: localhost
        rcon_port: 25575
        rcon_password: dragon123
        EOF
        cat config-ci.yaml

    - name: Start Mineflayer Bridge
      run: |
        echo "ðŸš€ Starting Mineflayer Bridge..."
        docker run -d \
          --name pilaf-bridge \
          -p 8888:3000 \
          --add-host=minecraft:127.0.0.1 \
          -e MC_HOST=minecraft \
          -e MC_PORT=25565 \
          pilaf-mineflayer-bridge

    - name: Verify Mineflayer Bridge is ready
      run: |
        echo "â³ Waiting for Mineflayer Bridge to be ready..."
        for i in {1..30}; do
          if curl -f http://localhost:8888/health 2>/dev/null; then
            echo "âœ… Mineflayer Bridge is ready!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Mineflayer Bridge failed to start"
            docker logs pilaf-bridge
            exit 1
          fi
          echo "Waiting... ($i/30)"
          sleep 2
        done

    - name: Wait for Minecraft server to fully initialize
      run: |
        echo "â³ Waiting additional time for Minecraft server to fully initialize..."
        echo "This ensures entity spawning and RCON commands work properly..."
        sleep 30
        echo "âœ… Wait complete, server should be fully ready"

    - name: Run integration tests (JUnit)
      run: |
        echo "ðŸš€ Running JUnit integration tests..."
        ./gradlew integrationTest

    - name: Run Pilaf story tests
      run: |
        echo "ðŸ“œ Running Pilaf story tests..."
        ./gradlew run --args="--config config-ci.yaml bin/test/simple-test.yaml" || true
        ./gradlew run --args="--config config-ci.yaml test-story-1-basic-items.yaml" || true
        ./gradlew run --args="--config config-ci.yaml test-story-2-entities.yaml" || true
        ./gradlew run --args="--config config-ci.yaml test-story-3-movement.yaml" || true
        ./gradlew run --args="--config config-ci.yaml test-story-4-commands.yaml" || true
        ./gradlew run --args="--config config-ci.yaml demo-story.yaml" || true

    - name: Collect Pilaf HTML reports
      run: |
        echo "ðŸ“Š Collecting Pilaf HTML reports..."
        mkdir -p build/reports/pilaf
        if [ -d "target/pilaf-reports" ]; then
          cp -r target/pilaf-reports/* build/reports/pilaf/ 2>/dev/null || true
        fi
        ls -la target/pilaf-reports/ 2>/dev/null || echo "No Pilaf reports yet"
        ls -la build/reports/pilaf/ 2>/dev/null || echo "No reports copied"

    - name: Publish JUnit Integration Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always() && !cancelled()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        files: "build/test-results/integrationTest/**/*.xml"
        check_name: Integration Test Report
        comment_mode: "off"
        fail_on: "test failures"

    - name: Upload integration test results
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: integration-test-results
        path: |
          build/test-results/integrationTest/
          build/reports/tests/integrationTest/
        retention-days: 30

    - name: Upload Pilaf HTML reports
      if: always()
      uses: actions/upload-artifact@v6
      with:
        name: pilaf-html-reports
        path: |
          target/pilaf-reports/
          build/reports/pilaf/
        retention-days: 30
        if-no-files-found: ignore

    - name: Display integration test summary
      if: always()
      run: |
        echo "## ðŸŽ¯ Integration Test Artifacts" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Test results and reports have been uploaded as artifacts:" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Artifact | Description |" >> $GITHUB_STEP_SUMMARY
        echo "|----------|-------------|" >> $GITHUB_STEP_SUMMARY
        echo "| \`integration-test-results\` | JUnit test results and Gradle reports |" >> $GITHUB_STEP_SUMMARY
        echo "| \`pilaf-html-reports\` | Interactive HTML test reports with Vue.js UI |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ -d build/reports/tests/integrationTest ]; then
          echo "### âœ… JUnit Integration Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Gradle integration tests completed successfully." >> $GITHUB_STEP_SUMMARY
        fi

        if [ -d target/pilaf-reports ] || [ -d build/reports/pilaf ]; then
          echo "### ðŸ“œ Pilaf Story Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**HTML Reports**: Download the \`pilaf-html-reports\` artifact to view interactive reports." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          ls -la target/pilaf-reports/ 2>/dev/null || ls -la build/reports/pilaf/ 2>/dev/null || echo "No reports found" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        fi

    - name: Show Docker logs on failure
      if: failure()
      run: |
        echo "=== Minecraft Server Logs ===" >> $GITHUB_STEP_SUMMARY
        docker logs pilaf-minecraft 2>&1 | tail -50 >> $GITHUB_STEP_SUMMARY || true
        echo "=== Mineflayer Bridge Logs ===" >> $GITHUB_STEP_SUMMARY
        docker logs pilaf-bridge 2>&1 | tail -50 >> $GITHUB_STEP_SUMMARY || true

    - name: Stop Mineflayer Bridge
      if: always()
      run: |
        echo "ðŸ›‘ Stopping Mineflayer Bridge..."
        docker stop pilaf-bridge 2>/dev/null || true
        docker rm pilaf-bridge 2>/dev/null || true
