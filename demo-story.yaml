# PILAF New User Demonstrator
# ============================
# This file demonstrates the basic PILAF testing workflow.
# It connects to a PaperMC server via RCON and Mineflayer client,
# executes server commands and client actions, and produces a test report.
#
# Usage:
#   1. Ensure PaperMC server and Mineflayer bridge are running
#   2. Run the test: gradle run --args="--config config-demo.yaml demo-story.yaml"
#   3. View the report in target/pilaf-reports/

name: "PILAF New User Demonstrator"
description: |
  A comprehensive demonstrator that shows PILAF's basic capabilities:
  - RCON server commands for server management
  - Client actions for player simulation
  - Real interaction between server and client
  - Clean setup and cleanup procedures
  - Test report generation

# Backend configuration
backend: mineflayer

setup:
  # Step 1: Connect the Mineflayer player first
  - action: "connect"
    player: "pilaf_tester"
    name: "Connect player to server"

  # Step 2: Wait for player to fully connect
  - action: "wait"
    duration: 10
    name: "Wait for player connection"

  # Step 3: Announce test start via server broadcast (RCON)
  - action: "servercommand"
    command: "say [PILAF] Starting new user demonstrator test..."
    name: "Announce test start"

  # Step 4: Set up the test environment - creative mode (RCON)
  - action: "servercommand"
    command: "gamemode creative pilaf_tester"
    name: "Set player to creative mode"

  # Step 5: Clear any existing items for clean test (RCON)
  - action: "servercommand"
    command: "clear pilaf_tester"
    name: "Clear player inventory"

  # Step 6: Set spawn point for convenience (RCON)
  - action: "servercommand"
    command: "spawnpoint pilaf_tester 0 64 0"
    name: "Set player spawn point"

steps:
  # =====================================================
  # SECTION 1: Basic Item Operations
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing basic item operations..."
    name: "Announce item test section"

  # Give the player a diamond sword via RCON
  - action: "servercommand"
    command: "give pilaf_tester diamond_sword 1"
    name: "Give diamond sword via RCON"

  # Give golden apples via client action
  - action: "giveitem"
    player: "pilaf_tester"
    item: "golden_apple"
    count: 5
    name: "Give golden apples via client"

  # Give cobblestone (client action)
  - action: "giveitem"
    player: "pilaf_tester"
    item: "cobblestone"
    count: 64
    name: "Give cobblestone via client"

  # Check player inventory (client action)
  - action: "getinventory"
    player: "pilaf_tester"
    name: "Check player inventory"

  # =====================================================
  # SECTION 2: Player Movement
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing player movement..."
    name: "Announce movement test section"

  # Teleport player via RCON
  - action: "servercommand"
    command: "tp pilaf_tester 100 64 100"
    name: "Teleport player via RCON"

  # Wait for teleport
  - action: "wait"
    duration: 3
    name: "Wait for teleport"

  # Get player position (client action)
  - action: "get_player_position"
    player: "pilaf_tester"
    name: "Get player position"

  # =====================================================
  # SECTION 3: Entity Spawning
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing entity spawning..."
    name: "Announce entity test section"

  # Spawn a zombie near the player (RCON)
  - action: "servercommand"
    command: "summon zombie 105 65 105"
    name: "Spawn zombie via RCON"

  # Spawn a cow (RCON)
  - action: "servercommand"
    command: "summon cow 95 65 95"
    name: "Spawn cow via RCON"

  # Wait for entities to spawn
  - action: "wait"
    duration: 2
    name: "Wait for entity spawn"

  # Get nearby entities (client action)
  - action: "getentities"
    player: "pilaf_tester"
    name: "Get nearby entities"

  # =====================================================
  # SECTION 4: Chat Communication
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing chat messages..."
    name: "Announce chat test section"

  # Player sends a chat message (client action)
  - action: "send_chat_message"
    player: "pilaf_tester"
    message: "Hello from PILAF demonstrator!"
    name: "Send chat message as player"

  # =====================================================
  # SECTION 5: Health and Status
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing health commands..."
    name: "Announce health test section"

  # Get player health (client action)
  - action: "get_player_health"
    player: "pilaf_tester"
    name: "Get player health"

  # =====================================================
  # SECTION 6: Environment Commands
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing environment commands..."
    name: "Announce environment test section"

  # Set weather to clear (RCON)
  - action: "servercommand"
    command: "weather clear 600"
    name: "Set clear weather"

  # Get weather status (client action)
  - action: "get_weather"
    name: "Get weather status"

  # Get world time (client action)
  - action: "get_world_time"
    name: "Get world time"

  # =====================================================
  # SECTION 7: Server Status
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Checking server status..."
    name: "Announce status section"

  # List online players (RCON)
  - action: "servercommand"
    command: "list"
    name: "List players"

  # =====================================================
  # SECTION 8: State Management and Comparison
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing state management and comparison..."
    name: "Announce state comparison section"

  # Capture initial player inventory
  - action: "getinventory"
    player: "pilaf_tester"
    name: "Get initial inventory"
    storeAs: "inventory_before"

  # Store initial inventory count
  - action: "store_state"
    variableName: "item_count_before"
    fromCommandResult: "inventory_before"
    name: "Store initial item count"

  # Give player an item (this should change inventory)
  - action: "servercommand"
    command: "give pilaf_tester iron_sword 1"
    name: "Give iron sword to player"

  # Wait for item to be received
  - action: "wait"
    duration: 2
    name: "Wait for item delivery"

  # Capture new inventory
  - action: "getinventory"
    player: "pilaf_tester"
    name: "Get inventory after adding item"
    storeAs: "inventory_after"

  # Print stored states to show in report
  - action: "print_stored_state"
    variableName: "inventory_before"
    name: "Print initial inventory state"

  - action: "print_stored_state"
    variableName: "inventory_after"
    name: "Print inventory after adding item"

  # Compare states to detect the change
  - action: "compare_states"
    state1: "inventory_before"
    state2: "inventory_after"
    name: "Compare inventory states"
    storeAs: "inventory_comparison"

  # Print the comparison result
  - action: "print_state_comparison"
    variableName: "inventory_comparison"
    name: "Print inventory comparison"

  # =====================================================
  # SECTION 9: Entity Spawn Detection
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Testing entity spawn detection..."
    name: "Announce entity spawn section"

  # Capture initial entity count
  - action: "getentities"
    player: "pilaf_tester"
    name: "Get initial entity count"
    storeAs: "entities_before"

  # Print initial entity count
  - action: "print_stored_state"
    variableName: "entities_before"
    name: "Print initial entity count"

  # Spawn a new entity
  - action: "servercommand"
    command: "summon pig 110 65 110"
    name: "Spawn pig via RCON"

  # Wait for entity to spawn
  - action: "wait"
    duration: 2
    name: "Wait for entity spawn"

  # Capture new entity count
  - action: "getentities"
    player: "pilaf_tester"
    name: "Get entity count after spawn"
    storeAs: "entities_after"

  # Print new entity count
  - action: "print_stored_state"
    variableName: "entities_after"
    name: "Print entity count after spawn"

  # Compare entity states
  - action: "compare_states"
    state1: "entities_before"
    state2: "entities_after"
    name: "Compare entity counts"
    storeAs: "entity_comparison"

  # Print the comparison
  - action: "print_state_comparison"
    variableName: "entity_comparison"
    name: "Print entity comparison"

cleanup:
  # =====================================================
  # CLEANUP: Restore test environment
  # =====================================================
  - action: "servercommand"
    command: "say [PILAF] Cleaning up test environment..."
    name: "Announce cleanup"

  # Remove spawned entities (RCON)
  - action: "servercommand"
    command: "kill @e[type=zombie,x=105,y=65,z=105,distance=..10]"
    name: "Remove spawned zombie"

  - action: "servercommand"
    command: "kill @e[type=cow,x=95,y=65,z=95,distance=..10]"
    name: "Remove spawned cow"

  - action: "servercommand"
    command: "kill @e[type=pig,x=110,y=65,z=110,distance=..10]"
    name: "Remove spawned pig"

  # Clear player inventory (RCON) - removes iron_sword and other items
  - action: "servercommand"
    command: "clear pilaf_tester"
    name: "Clear player inventory"

  # Restore gamemode to survival (RCON)
  - action: "servercommand"
    command: "gamemode survival pilaf_tester"
    name: "Restore survival mode"

  # Disconnect the player
  - action: "disconnect"
    player: "pilaf_tester"
    name: "Disconnect player"

  # Final announcement
  - action: "servercommand"
    command: "say [PILAF] Demonstrator test completed successfully!"
    name: "Test completion announcement"
