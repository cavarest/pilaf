# Test: Multi-Packet RCON Response
# Purpose: Verify Pilaf can handle RCON responses larger than 4096 bytes
#
# This test uses exponential duplication to create 256 entities,
# then queries them all to generate a multi-packet response.
#
# Multi-packet response technique from gaming.stackexchange.com:
# https://gaming.stackexchange.com/questions/385273
#
# Tags: integration, multipacket, rcon, large-response

name: "Multi-Packet RCON Response Test"
description: "Verifies Pilaf can handle RCON responses larger than 4096 bytes using exponential duplication"

setup:
  - action: "execute_rcon_command"
    command: "say [TEST] Starting multi-packet RCON response test"
    name: "Announce test start"

  # Create first armor stand with 'dup' tag
  - action: "execute_rcon_command"
    command: "summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Spawn first duplicator armor stand"

  # Exponentially duplicate 8 times to get 256 entities (1→2→4→8→16→32→64→128→256)
  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 1 (2 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 2 (4 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 3 (8 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 4 (16 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 5 (32 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 6 (64 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 7 (128 entities)"

  - action: "execute_rcon_command"
    command: "execute as @e[tag=dup] run summon armor_stand ~ ~ ~ {Tags:[\"dup\"],Invisible:1b,NoGravity:1b}"
    name: "Duplication round 8 (256 entities)"

  # Wait for entities to be fully registered
  - action: "wait"
    duration: 500
    name: "Wait for entity registration"

steps:
  # Query all 256 entities using the magic command
  # This runs /data get entity @s FOR EACH ENTITY, not once for all entities
  # This generates a massive multi-packet response (typically >10KB)
  - action: "execute_rcon_with_capture"
    command: "execute as @e[tag=dup] run data get entity @s"
    store_as: "all_entity_data"
    name: "Query all 256 entities (multi-packet response)"

  # Verify the response was captured
  - action: "print_state_comparison"
    variable_name: "all_entity_data"
    name: "Display captured multi-packet response"

  # Also capture a smaller response for comparison
  - action: "execute_rcon_command"
    command: "say [TEST] Multi-packet response captured"
    name: "Confirm capture complete"

cleanup:
  # Remove all duplicated entities
  - action: "execute_rcon_command"
    command: "kill @e[tag=dup]"
    name: "Clean up all duplicated armor stands"

  - action: "execute_rcon_command"
    command: "say [TEST] Multi-packet test cleanup complete"
    name: "Announce cleanup complete"
