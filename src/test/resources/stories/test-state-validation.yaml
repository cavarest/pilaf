# Test: State Validation Test
# Category: Combined Workflows
# Purpose: Tests state before/after comparison and validation

name: "State Validation Test"
description: |
  Tests comprehensive state validation including before/after
  comparisons for inventory, position, entities, and environment.

backend: mineflayer

setup:
  - action: "connect"
    player: "pilaf_validation"
    name: "Connect validation test player"

  - action: "wait"
    duration: 5
    name: "Wait for connection"

  - action: "servercommand"
    command: "say [Pilaf] Starting state validation test..."
    name: "Announce test start"

  - action: "servercommand"
    command: "gamemode creative pilaf_validation"
    name: "Set creative mode"

  - action: "servercommand"
    command: "clear pilaf_validation"
    name: "Clear inventory"

steps:
  # Capture all initial states
  - action: "get_player_position"
    player: "pilaf_validation"
    name: "Get initial position"
    storeAs: "pos_before"

  - action: "getinventory"
    player: "pilaf_validation"
    name: "Get initial inventory"
    storeAs: "inv_before"

  - action: "getentities"
    player: "pilaf_validation"
    name: "Get initial entities"
    storeAs: "ent_before"

  # Print all initial states
  - action: "print_stored_state"
    variableName: "pos_before"
    name: "Print initial position"

  - action: "print_stored_state"
    variableName: "ent_before"
    name: "Print initial entities"

  # Make changes
  - action: "servercommand"
    command: "tp pilaf_validation 500 64 500"
    name: "Teleport to new location"

  - action: "wait"
    duration: 3
    name: "Wait for teleport"

  - action: "giveitem"
    player: "pilaf_validation"
    item: "diamond_hoe"
    count: 1
    name: "Give diamond hoe"

  - action: "servercommand"
    command: "summon wolf 505 65 505"
    name: "Spawn wolf"

  - action: "wait"
    duration: 2
    name: "Wait for spawn"

  # Capture all final states
  - action: "get_player_position"
    player: "pilaf_validation"
    name: "Get final position"
    storeAs: "pos_after"

  - action: "getinventory"
    player: "pilaf_validation"
    name: "Get final inventory"
    storeAs: "inv_after"

  - action: "getentities"
    player: "pilaf_validation"
    name: "Get final entities"
    storeAs: "ent_after"

  # Compare all states
  - action: "compare_states"
    state1: "pos_before"
    state2: "pos_after"
    name: "Compare positions"
    storeAs: "pos_comparison"

  - action: "compare_states"
    state1: "inv_before"
    state2: "inv_after"
    name: "Compare inventories"
    storeAs: "inv_comparison"

  - action: "compare_states"
    state1: "ent_before"
    state2: "ent_after"
    name: "Compare entities"
    storeAs: "ent_comparison"

  # Print all comparisons
  - action: "print_state_comparison"
    variableName: "pos_comparison"
    name: "Print position comparison"

  - action: "print_state_comparison"
    variableName: "inv_comparison"
    name: "Print inventory comparison"

  - action: "print_state_comparison"
    variableName: "ent_comparison"
    name: "Print entity comparison"

cleanup:
  - action: "servercommand"
    command: "kill @e[type=wolf,x=505,y=65,z=505,distance=..20]"
    name: "Remove spawned wolf"

  - action: "servercommand"
    command: "clear pilaf_validation"
    name: "Clear inventory"

  - action: "servercommand"
    command: "tp pilaf_validation 0 64 0"
    name: "Return to spawn"

  - action: "servercommand"
    command: "say [Pilaf] State validation test completed"
    name: "Announce completion"

  - action: "disconnect"
    player: "pilaf_validation"
    name: "Disconnect test player"
