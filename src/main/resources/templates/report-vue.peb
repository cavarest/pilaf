<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pilaf Test Report - {{ suiteName }}</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Vue 3 -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

  <!-- w-jsonview-tree library -->
  <script src="https://cdn.jsdelivr.net/npm/w-jsonview-tree@1.0.31/dist/w-jsonview-tree.umd.js"></script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- jsondiffpatch CSS -->
  <link rel="stylesheet" href="https://esm.sh/jsondiffpatch@0.6.0/lib/formatters/styles/html.css" type="text/css" />

  <!-- Minecraft Fonts -->
  <link href="https://fonts.cdnfonts.com/css/minecraft-pe" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/minecraft-title" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/minecraft-items" rel="stylesheet">
  <link href="https://fonts.cdnfonts.com/css/minecraftia" rel="stylesheet">

  <style>
    {{ cssContent | raw }}

    /* Vue transition styles */
    .slide-enter-active, .slide-leave-active {
      transition: all 0.3s ease;
    }
    .slide-enter-from, .slide-leave-to {
      opacity: 0;
      transform: translateY(-10px);
    }

    /* Fix for Vue hidden content */
    [v-cloak] { display: none !important; }

    /* Story arrow rotation */
    .arrow-rotated {
      transform: rotate(90deg);
    }

    /* Minecraft font styles */
    .font-minecraft {
      font-family: 'Minecraftia', monospace;
    }
    .font-minecraft-title {
      font-family: 'Minecraft Ten', 'Minecraft Title', sans-serif;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
  <!-- Report Data (Embedded JSON) - This is the ONLY semantic content in HTML -->
  <script id="report-data" type="application/json">{{ storiesJson | raw }}</script>

  <!-- Vue Application Root with Loading Spinner -->
  <div id="app">
    <!-- Loading State - Shown until Vue mounts -->
    <div id="loading-spinner" class="flex flex-col items-center justify-center min-h-screen">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500 mb-4"></div>
      <p class="text-gray-400 text-lg">Loading Pilaf Test Report...</p>
      <p class="text-gray-600 text-sm mt-2">Initializing Vue.js application</p>
    </div>
  </div>

  <!-- Load jsondiffpatch as module -->
  <script type="module">
    import * as jsondiffpatch from 'https://esm.sh/jsondiffpatch@0.6.0';
    import { html } from 'https://esm.sh/jsondiffpatch@0.6.0/formatters/html';

    // Make these available globally for Vue app
    window.jsondiffpatch = jsondiffpatch;
    window.jsondiffpatch.formatters = { html };
    window.htmlFormatter = html;  // Alias for backward compatibility

    // Dispatch event when ready
    window.dispatchEvent(new Event('jsondiffpatch-ready'));
  </script>

  <!-- Vue 3 Application -->
  <script>
  (function() {
    'use strict';

    const { createApp, ref, reactive, computed, onMounted, nextTick, watch, h } = Vue;

    // Vue.js Template - All rendering is done by Vue.js from embedded JSON
    // Using string concatenation to avoid Pebble template conflicts
    const vueTemplate =
      '<div id="app-content">' +
      '  <header class="bg-gray-800 border-b border-gray-700 sticky top-0 z-50">' +
      '    <div class="max-w-7xl mx-auto px-4 py-4">' +
      '      <div class="flex items-center justify-between">' +
      '        <div>' +
      '          <h1 class="text-xl font-bold text-white" style="font-family: \'MINECRAFT PE\', sans-serif;">Pilaf Test Report</h1>' +
      '          <p class="text-sm text-gray-400">{{ "{{" }} report.suiteName {{ "}}" }}</p>' +
      '        </div>' +
      '        <div class="flex items-center gap-4">' +
      '          <span class="px-3 py-1 rounded-full text-sm font-semibold"' +
      '                :class="report.passed ? \'bg-green-900 text-green-300\' : \'bg-red-900 text-red-300\'">' +
      '            {{ "{{" }} report.passed ? \'PASSED\' : \'FAILED\' {{ "}}" }}' +
      '          </span>' +
      '        </div>' +
      '      </div>' +
      '      <div class="mt-4 flex flex-wrap gap-6 text-sm">' +
      '        <div class="flex items-center gap-2">' +
      '          <span class="text-gray-400">Duration:</span>' +
      '          <span class="font-minecraft font-semibold">{{ "{{" }} formatDuration(report.durationMs) {{ "}}" }}</span>' +
      '        </div>' +
      '        <div class="flex items-center gap-2">' +
      '          <span class="text-gray-400">Stories:</span>' +
      '          <span class="font-semibold">{{ "{{" }} stories.length {{ "}}" }}</span>' +
      '        </div>' +
      '        <div class="flex items-center gap-2">' +
      '          <span class="text-gray-400">Total Steps:</span>' +
      '          <span class="font-semibold">{{ "{{" }} totalSteps {{ "}}" }}</span>' +
      '        </div>' +
      '        <div class="flex items-center gap-2">' +
      '          <span class="text-gray-400">Passed:</span>' +
      '          <span class="font-semibold text-green-400">{{ "{{" }} passedSteps {{ "}}" }}</span>' +
      '        </div>' +
      '        <div class="flex items-center gap-2">' +
      '          <span class="text-gray-400">Failed:</span>' +
      '          <span class="font-semibold text-red-400">{{ "{{" }} failedSteps {{ "}}" }}</span>' +
      '        </div>' +
      '      </div>' +
      '      <div class="mt-4 flex gap-2">' +
      '        <button @click="expandAll" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded">Expand All</button>' +
      '        <button @click="collapseAll" class="px-3 py-1 text-xs bg-gray-700 hover:bg-gray-600 rounded">Collapse All</button>' +
      '      </div>' +
      '    </div>' +
      '  </header>' +
      '  <main class="max-w-7xl mx-auto px-4 py-6">' +
      '    <div class="space-y-4">' +
      '      <div v-for="(story, storyIndex) in stories" :key="storyIndex" class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700">' +
      '        <div class="px-4 py-3 bg-gray-800 border-b border-gray-700 flex items-center justify-between cursor-pointer" @click="toggleStory(storyIndex)">' +
      '          <div class="flex items-center gap-3">' +
      '            <span>{{ "{{" }} expandedStories[storyIndex] ? \'‚ñº\' : \'‚ñ∂\' {{ "}}" }}</span>' +
      '            <div>' +
      '              <h2 class="text-lg font-semibold text-white">{{ "{{" }} story.name {{ "}}" }}</h2>' +
      '              <p class="text-xs text-gray-400">{{ "{{" }} story.steps.length || 0 {{ "}}" }} steps</p>' +
      '            </div>' +
      '          </div>' +
      '          <span class="text-gray-400">{{ "{{" }} story.passedCount {{ "}}" }} passed, {{ "{{" }} story.failedCount {{ "}}" }} failed</span>' +
      '        </div>' +
      '        <div v-if="expandedStories[storyIndex]" v-show="expandedStories[storyIndex]" class="border-t border-gray-700">' +
      '          <div v-for="(step, stepIndex) in story.steps" :key="stepIndex" class="step-card border-b border-gray-700 last:border-0 p-4">' +
      '            <div class="flex items-start gap-4">' +
      '              <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold"' +
      '                   :style="step.passed ? \'background-color: #166534; color: #86efac\' : \'background-color: #991b1b; color: #fca5a5\'">' +
      '                {{ "{{" }} stepIndex + 1 {{ "}}" }}' +
      '              </div>' +
      '              <div class="flex-1">' +
      '                <div class="text-sm text-gray-400 mb-1">{{ "{{" }} step.name {{ "}}" }}</div>' +
      '                <!-- Execution Context Badge -->' +
      '                <div v-if="step.executionContext" class="flex items-center gap-2 mb-2">' +
      '                  <span class="px-2 py-0.5 rounded text-xs font-semibold"' +
      '                        :class="{' +
      '                          \'bg-purple-900 text-purple-300\': step.executionContext.executor === \'RCON\',' +
      '                          \'bg-blue-900 text-blue-300\': step.executionContext.executor === \'PLAYER\',' +
      '                          \'bg-green-900 text-green-300\': step.executionContext.executor === \'MINEFLAYER\',' +
      '                          \'bg-cyan-900 text-cyan-300\': step.executionContext.executor === \'STATE\',' +
      '                          \'bg-orange-900 text-orange-300\': step.executionContext.executor === \'ASSERT\',' +
      '                          \'bg-gray-700 text-gray-300\': step.executionContext.executor === \'SYSTEM\',' +
      '                          \'bg-gray-600 text-gray-400\': !step.executionContext.executor || step.executionContext.executor === \'UNKNOWN\'' +
      '                        }">' +
      '                    {{ "{{" }} step.executionContext.executor === \'RCON\' ? \'üñ•Ô∏è RCON\' : ' +
      '                       step.executionContext.executor === \'PLAYER\' ? \'üë§ PLAYER\' : ' +
      '                       step.executionContext.executor === \'MINEFLAYER\' ? \'ü§ñ MINEFLAYER\' : ' +
      '                       step.executionContext.executor === \'STATE\' ? \'üìä STATE\' : ' +
      '                       step.executionContext.executor === \'ASSERT\' ? \'‚úÖ ASSERT\' : ' +
      '                       step.executionContext.executor === \'SYSTEM\' ? \'‚öôÔ∏è SYSTEM\' : \'‚ùì UNKNOWN\' {{ "}}" }}' +
      '                  </span>' +
      '                  <span v-if="step.executionContext.executorPlayer" class="text-xs text-gray-400">' +
      '                    ‚Üí {{ "{{" }} step.executionContext.executorPlayer {{ "}}" }}' +
      '                    <span v-if="step.executionContext.isOperator" class="ml-1 px-1 py-0.5 bg-yellow-900 text-yellow-300 rounded text-xs">OP</span>' +
      '                  </span>' +
      '                </div>' +
      '                <div v-if="step.action" class="mt-2">' +
      '                  <p class="text-xs text-gray-500 uppercase">Command</p>' +
      '                  <pre class="mt-1 px-3 py-2 bg-gray-900 rounded text-xs font-minecraft text-gray-300">{{ "{{" }} step.action {{ "}}" }}</pre>' +
      '                </div>' +
      '                <!-- Response: Show actual response data for get actions and compare_states -->' +
      '                <div v-if="step.actual && (!step.stateBefore || step.action.includes(\'compare\'))" class="mt-2">' +
      '                  <p class="text-xs text-gray-500 uppercase">{{ "{{" }} step.action.includes(\'compare\') ? \'Comparison Result\' : \'Response (Raw)\' {{ "}}" }}</p>' +
      '                  <pre class="mt-1 px-3 py-2 bg-gray-900 rounded text-xs text-purple-400 font-minecraft json-response" :data-json="step.actual">{{ "{{" }} step.actual {{ "}}" }}</pre>' +
      '                </div>' +
      '                <!-- Extracted JSON: Show parsed JSON from RCON responses -->' +
      '                <div v-if="step.extractedJson" class="mt-2">' +
      '                  <p class="text-xs text-gray-500 uppercase">Extracted JSON</p>' +
      '                  <pre class="mt-1 px-3 py-2 bg-gray-900 rounded text-xs text-green-400 font-minecraft json-response" :data-json="step.extractedJson">{{ "{{" }} step.extractedJson {{ "}}" }}</pre>' +
      '                </div>' +
      '                <!-- State Comparison: Show BEFORE, AFTER, and Visual DIFF for compare_states actions -->' +
      '                <div v-if="step.stateBefore || step.stateAfter" class="mt-2">' +
      '                  <p class="text-xs text-gray-500 uppercase">State Comparison</p>' +
      '                  <div v-if="step.stateBefore" class="mt-1">' +
      '                    <span class="text-xs text-gray-400">BEFORE:</span>' +
      '                    <pre class="mt-1 px-3 py-2 bg-gray-900 rounded text-xs text-green-400 font-minecraft">{{ "{{" }} step.stateBefore {{ "}}" }}</pre>' +
      '                  </div>' +
      '                  <div v-if="step.stateAfter" class="mt-1">' +
      '                    <span class="text-xs text-gray-400">AFTER:</span>' +
      '                    <pre class="mt-1 px-3 py-2 bg-gray-900 rounded text-xs text-blue-400 font-minecraft">{{ "{{" }} step.stateAfter {{ "}}" }}</pre>' +
      '                  </div>' +
      '                  <!-- Visual Diff using jsondiffpatch -->' +
      '                  <div v-if="step.stateBefore && step.stateAfter" class="mt-2">' +
      '                    <span class="text-xs text-gray-400 uppercase">Visual Diff</span>' +
      '                    <div class="jsondiffpatch-visual-container mt-1 px-3 py-2 bg-gray-900 rounded border border-gray-700" ' +
      '                         :data-before="step.stateBefore" ' +
      '                         :data-after="step.stateAfter">' +
      '                      <div class="jsondiffpatch-diff text-xs"></div>' +
      '                    </div>' +
      '                  </div>' +
      '                </div>' +
      '              </div>' +
      '            </div>' +
      '          </div>' +
      '        </div>' +
      '      </div>' +
      '    </div>' +
      '  </main>' +
      '</div>';

    const PilafReport = {
      template: vueTemplate,
      setup() {
        // ============================================
        // REACTIVE STATE
        // ============================================
        const report = ref({});
        const stories = ref([]);
        const expandedStories = reactive({});
        const jsondiffpatchReady = ref(false);

        // ============================================
        // COMPUTED PROPERTIES
        // ============================================
        const totalSteps = computed(() =>
          stories.value.reduce((sum, story) => sum + (story.steps?.length || 0), 0)
        );

        const passedSteps = computed(() =>
          stories.value.reduce((sum, story) =>
            sum + (story.steps?.filter(s => s.passed).length || 0), 0)
        );

        const failedSteps = computed(() =>
          stories.value.reduce((sum, story) =>
            sum + (story.steps?.filter(s => !s.passed).length || 0), 0)
        );

        // ============================================
        // STORY TOGGLE METHODS
        // ============================================
        const toggleStory = (index) => {
          expandedStories[index] = !expandedStories[index];
        };

        const expandAll = () => {
          stories.value.forEach((_, index) => {
            expandedStories[index] = true;
          });
        };

        const collapseAll = () => {
          stories.value.forEach((_, index) => {
            expandedStories[index] = false;
          });
        };

        // ============================================
        // RENDERING METHODS
        // ============================================

        /**
         * Renders all responses and diffs for visible content
         */
        const renderAllContent = () => {
          // Render all JSON responses using w-jsonview-tree
          document.querySelectorAll('.json-response').forEach(container => {
            const jsonData = container.getAttribute('data-json');
            if (jsonData) {
              renderJsonResponse(container, jsonData);
            }
          });

          // Render all visual diffs using jsondiffpatch
          document.querySelectorAll('.jsondiffpatch-visual-container').forEach(container => {
            const before = container.getAttribute('data-before');
            const after = container.getAttribute('data-after');
            if (before && after) {
              renderDiffToElement(container, before, after);
            }
          });

          // Render all diffs using jsondiffpatch (legacy support)
          document.querySelectorAll('.jsondiffpatch-container').forEach(container => {
            const before = container.getAttribute('data-before');
            const after = container.getAttribute('data-after');
            if (before && after) {
              renderDiffToElement(container, before, after);
            }
          });

          // Render all diffs by finding diff-container elements (legacy support)
          document.querySelectorAll('.diff-container').forEach(container => {
            const key = container.getAttribute('data-key');
            const before = container.getAttribute('data-before');
            const after = container.getAttribute('data-after');
            if (before && after) {
              renderDiffToElement(container, before, after);
            }
          });
        };

        /**
         * Renders a JSON response using w-jsonview-tree
         */
        const renderJsonResponse = (container, jsonData) => {
          // Helper function to escape HTML
          const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
          };

          try {
            // Try to parse and format as JSON
            const obj = JSON.parse(jsonData);
            const formatted = JSON.stringify(obj, null, 2);

            // Use w-jsonview-tree if available
            if (window.jsonview && typeof window.jsonview.render === 'function') {
              try {
                const tree = window.jsonview.render(obj, container);
                container.innerHTML = '';
                container.appendChild(tree);
                return;
              } catch (e) {
                console.log('w-jsonview-tree render failed, falling back to pre tag');
              }
            }

            // Fallback: format as pretty-printed JSON in a pre tag
            container.innerHTML = '<pre class="json-pretty">' + escapeHtml(formatted) + '</pre>';
          } catch (e) {
            // Not valid JSON, show as plain text
            container.innerHTML = escapeHtml(jsonData);
          }
        };

        /**
         * Renders a JSON diff to a specific container element using jsondiffpatch HTML formatter
         */
        const renderDiffToElement = (container, before, after) => {
          if (!window.jsondiffpatch) {
            console.log('jsondiffpatch not ready yet');
            return;
          }

          try {
            const beforeObj = before ? JSON.parse(before) : {};
            const afterObj = after ? JSON.parse(after) : {};

            const differ = window.jsondiffpatch.create({
              objectHash: function(obj) {
                return obj.id || obj._id || obj.name;
              },
              arrays: {
                detectMove: true
              },
              textDiff: {
                minLength: 60
              }
            });

            const delta = differ.diff(beforeObj, afterObj);

            if (!delta) {
              container.innerHTML = '<div class="jsondiffpatch-diff text-xs text-gray-400">No changes detected</div>';
              return;
            }

            // Use jsondiffpatch's HTML formatter
            const html = window.jsondiffpatch.formatters.html.format(delta, beforeObj);
            container.innerHTML = html;

            // Style the diff output
            const diffElement = container.querySelector('.jsondiffpatch');
            if (diffElement) {
              diffElement.style.fontSize = '12px';
              diffElement.style.fontFamily = 'monospace';
            }
          } catch (e) {
            console.log('Failed to render diff:', e.message);
            container.innerHTML = '<div class="jsondiffpatch-diff text-xs text-gray-400">Unable to generate diff: ' + e.message + '</div>';
          }
        };

        // ============================================
        // UTILITY METHODS
        // ============================================
        const formatDuration = (ms) => {
          if (!ms) return '0ms';
          if (ms < 1000) return ms + 'ms';
          if (ms < 60000) return (ms / 1000).toFixed(1) + 's';
          return Math.floor(ms / 60000) + 'm ' + Math.floor((ms % 60000) / 1000) + 's';
        };

        // ============================================
        // LIFECYCLE
        // ============================================
        onMounted(() => {
          // Hide loading spinner - Vue has mounted and will render content
          const loadingSpinner = document.getElementById('loading-spinner');
          if (loadingSpinner) {
            loadingSpinner.style.display = 'none';
          }

          // Parse report data from embedded JSON
          const dataElement = document.getElementById('report-data');
          if (dataElement) {
            try {
              report.value = JSON.parse(dataElement.textContent);
              stories.value = report.value.stories || [];

              // Initialize all stories as expanded (to show state comparisons)
              stories.value.forEach((_, index) => {
                expandedStories[index] = true;
              });

              // Render all diffs after stories are expanded
              nextTick(() => {
                renderAllContent();
              });

              console.log('Report data loaded:', stories.value.length, 'stories');
            } catch (e) {
              console.error('Failed to parse report data:', e);
            }
          }

          // Listen for jsondiffpatch ready event
          window.addEventListener('jsondiffpatch-ready', () => {
            jsondiffpatchReady.value = true;
            console.log('jsondiffpatch is ready');

            // Re-render any pending diffs
            nextTick(() => {
              renderAllContent();
            });
          });

          // Check if jsondiffpatch is already available
          if (window.jsondiffpatch) {
            jsondiffpatchReady.value = true;
            renderAllContent();
          }
        });

        // ============================================
        // RETURN PUBLIC API
        // ============================================
        return {
          // State
          report,
          stories,
          expandedStories,

          // Computed
          totalSteps,
          passedSteps,
          failedSteps,

          // Methods
          toggleStory,
          expandAll,
          collapseAll,
          formatDuration
        };
      }
    };

    // Create and mount the Vue application
    Vue.createApp(PilafReport).mount('#app');
  })();
  </script>

  <!-- Initialize Lucide Icons -->
  <script>
    // Initialize Lucide icons after DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      if (window.lucide) {
        window.lucide.createIcons();
      }
    });
  </script>
</body>
</html>
